#include "FoodSpawner.h"
#include "Utilities/Utilities.h"

#include <sstream>
#include <string>
#include <stdio.h>

USING_NS_CC;

void FoodSpawner::spawnFood(cocos2d::Layer *layerToSpawn)
{
    SpriteFrameCache* cache = SpriteFrameCache::getInstance();
    foodbatch = SpriteBatchNode::create("Atlases/food.png");
    cache->addSpriteFramesWithFile("Atlases/food.plist");

    foodAmount = 10;
    offsetFromCenter = 384;
    Size visibleSize = Director::getInstance()->getVisibleSize();

    for (int i = 0; i < foodAmount; i++)
    {
    	float currentAngle = ((UTIL::PI*2) / (float)foodAmount) * (float)i;
    	int randomSprite = arc4random() % 4;

    	std::ostringstream temp;
    	temp << randomSprite;
    	Sprite *sprite = Sprite::createWithSpriteFrameName("food" + temp.str() + ".png");

    	sprite->setPosition(Vec2(cos(currentAngle) * offsetFromCenter,
    							 sin(currentAngle) * offsetFromCenter));

    	sprite->setScale(0.75f);

    	foodChildren.pushBack(sprite);
    	foodbatch->addChild(sprite, 9);
    }

    foodbatch->setPosition(visibleSize.width/2, visibleSize.height + (visibleSize.height/6));

    layerToSpawn->addChild(foodbatch);
}

void FoodSpawner::updateFood(float delta)
{
	currentAngle += (delta * spinSpeed);

	if (currentAngle > UTIL::PI*2)
	{
		currentAngle = 0;
	}

	for (int i = 0; i < foodChildren.size(); i++)
	{
    	float offsetAngle = (((UTIL::PI*2) / (float)foodAmount) * (float)i) + ;
    	foodChildren.at(i)->setPosition(Vec2(cos(offsetAngle) * offsetFromCenter,
    							 	 	 	 sin(offsetAngle) * offsetFromCenter));
	}

	float spinSpeed = 75;
	foodbatch->setRotation(foodbatch->getRotation() + (delta * spinSpeed));
}

void FoodSpawner::grabFood(Vec2 mouthPos)
{
	Node *parentFood = foodbatch->getParent();

	for (int i = 0; i < foodChildren.size(); i++)
	{
		Node* foodNode = foodChildren.at(i);
		Vec2 foodWorldPos = foodbatch->getPosition() + foodChildren->getPosition();

		cocos2d::log("Food Children: %d", (int)UTIL::distance(foodWorldPos, mouthPos));

		if (UTIL::distance(foodWorldPos, mouthPos) < 128)
		{
			foodbatch->removeChild(foodChildren.at(i), true);
			break;
		}
	}
}
